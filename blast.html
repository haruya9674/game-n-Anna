<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Blast Puzzle</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:system-ui,sans-serif;
  background:linear-gradient(180deg,#fff1f8,#e8f8ff);
  text-align:center;
  padding:12px;
}

a.back{
  display:inline-block;
  margin-bottom:6px;
  padding:6px 12px;
  background:white;
  border-radius:12px;
  text-decoration:none;
  color:#333;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
}

.top{
  display:flex;
  justify-content:space-between;
  max-width:320px;
  margin:6px auto;
}

.panel{
  background:white;
  padding:6px 10px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
}

.grid{
  display:grid;
  gap:6px;
  margin:10px auto;
}

.cell{
  width:40px;
  height:40px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  cursor:pointer;
}

.red{background:#ff7675;}
.blue{background:#74b9ff;}
.yellow{background:#ffeaa7;}
.green{background:#55efc4;}
.purple{background:#a29bfe;}

.rocket{background:#fd79a8;color:white;}
.bomb{background:#2d3436;color:white;}

.fade{animation:fade .6s forwards;}
@keyframes fade{
  to{opacity:0;transform:scale(1.4);}
}

.boom{
  animation:boom .25s ease-out;
}
@keyframes boom{
  0%{transform:scale(1);}
  50%{transform:scale(1.5);}
  100%{transform:scale(1);}
}

#overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.9);
  display:none;
  align-items:center;
  justify-content:center;
  font-size:36px;
  font-weight:bold;
}
</style>
</head>

<body>

<a href="index.html" class="back">‚Üê Back to Menu</a>

<div class="top">
  <div class="panel" id="moves"></div>
  <div class="panel" id="goal"></div>
</div>

<div id="grid" class="grid"></div>
<div id="overlay">üéâ CLEAR!</div>

<script>
const COLORS=["red","blue","yellow","green","purple"];
const FADE_TIME=600;
let ROWS=6,COLS=6,movesLeft=20;
let goal={red:12};
let board=[];

function randColor(){
  return COLORS[Math.floor(Math.random()*COLORS.length)];
}

function init(){
  board=[];
  for(let r=0;r<ROWS;r++){
    board[r]=[];
    for(let c=0;c<COLS;c++){
      board[r][c]={type:"color",value:randColor()};
    }
  }
  updateUI(); draw();
}

function updateUI(){
  moves.textContent=`Moves: ${movesLeft}`;
  goalBox.textContent=
    "Goal: "+Object.entries(goal).map(([k,v])=>`${k}:${Math.max(0,v)}`).join(" ");
}

const moves=document.getElementById("moves");
const goalBox=document.getElementById("goal");

function draw(){
  const g=document.getElementById("grid");
  g.style.gridTemplateColumns=`repeat(${COLS},1fr)`;
  g.innerHTML="";
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    const cell=board[r][c];
    const d=document.createElement("div");
    d.className="cell";
    if(cell){
      d.classList.add(cell.type==="color"?cell.value:cell.type);
      if(cell.fade) d.classList.add("fade");
      if(cell.boom) d.classList.add("boom");
      d.textContent=cell.type==="rocket"?"üöÄ":cell.type==="bomb"?"üí£":"";
      d.onclick=()=>tap(r,c);
    }
    g.appendChild(d);
  }
}

function tap(r,c){
  if(movesLeft<=0||!board[r][c]) return;
  const cell=board[r][c];
  let targets=[];
  let bomb=0, rocket=0;

  // Âë®Âõ≤„ÅÆÂêà‰Ωì„ÉÅ„Çß„ÉÉ„ÇØ
  [[0,0],[1,0],[-1,0],[0,1],[0,-1]].forEach(([dr,dc])=>{
    const nr=r+dr,nc=c+dc;
    if(board[nr]?.[nc]?.type==="bomb") bomb++;
    if(board[nr]?.[nc]?.type==="rocket") rocket++;
  });

  // üí£√óüí£
  if(bomb>=2){
    for(let dr=-3;dr<=3;dr++)
      for(let dc=-3;dc<=3;dc++)
        if(board[r+dr]?.[c+dc]) targets.push([r+dr,c+dc]);
  }
  // üöÄ√óüöÄ or üí£√óüöÄ
  else if(rocket>=2|| (rocket&&bomb)){
    for(let d=-1;d<=1;d++){
      for(let i=0;i<COLS;i++) if(board[r+d]?.[i]) targets.push([r+d,i]);
      for(let i=0;i<ROWS;i++) if(board[i]?.[c+d]) targets.push([i,c+d]);
    }
  }
  // Âçò‰Ωì
  else if(cell.type==="rocket"){
    for(let i=0;i<COLS;i++) targets.push([r,i]);
    for(let i=0;i<ROWS;i++) targets.push([i,c]);
  }
  else if(cell.type==="bomb"){
    for(let dr=-2;dr<=2;dr++)
      for(let dc=-2;dc<=2;dc++)
        if(board[r+dr]?.[c+dc]) targets.push([r+dr,c+dc]);
  }
  else{
    targets.push([r,c]);
  }

  // ÈáçË§áÂâäÈô§
  const used={};
  targets=targets.filter(([x,y])=>{
    const k=x+","+y;
    if(used[k]) return false;
    used[k]=1; return true;
  });

  // „Éâ„É≥ÔºÅÊºîÂá∫
  targets.forEach(([x,y])=>{
    board[x][y].boom=true;
    board[x][y].fade=true;
  });
  draw();

  setTimeout(()=>{
    targets.forEach(([x,y])=>{
      if(board[x][y]?.type==="color" && goal[board[x][y].value]>0)
        goal[board[x][y].value]--;
      board[x][y]=null;
    });
    collapse(); refill();
  },FADE_TIME);

  movesLeft--; updateUI();
}

function collapse(){
  for(let c=0;c<COLS;c++){
    let s=[];
    for(let r=ROWS-1;r>=0;r--) if(board[r][c]) s.push(board[r][c]);
    for(let r=ROWS-1;r>=0;r--) board[r][c]=s.shift()||null;
  }
}

function refill(){
  for(let r=0;r<ROWS;r++)
    for(let c=0;c<COLS;c++)
      if(!board[r][c]) board[r][c]={type:"color",value:randColor()};
  draw();
}

init();
</script>

</body>
</html>
