<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Blast Puzzle Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:linear-gradient(#fff6fb,#f0fbff);
  text-align:center;
}

.top{
  display:flex;
  justify-content:space-between;
  padding:10px 14px;
  font-weight:bold;
}

#grid{
  display:grid;
  gap:6px;
  padding:12px;
  max-width:360px;
  margin:auto;
}

.cell{
  width:100%;
  aspect-ratio:1/1;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  font-weight:bold;
  color:white;
  cursor:pointer;
  transition:.25s;
}

.red{background:#ff6b6b}
.blue{background:#4dabf7}
.yellow{background:#ffd43b;color:#555}
.green{background:#69db7c}
.purple{background:#b197fc}

.rocket{background:#adb5bd}
.bomb{background:#868e96}

.fade{
  animation:fadeOut .6s forwards;
}

@keyframes fadeOut{
  to{opacity:0; transform:scale(1.3)}
}

#overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
  color:white;
  font-size:32px;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="top">
  <div id="stage">Stage 1</div>
  <div id="moves">Moves: 0</div>
</div>

<div id="goal"></div>
<div id="grid"></div>

<a href="index.html">â¬… Back to Menu</a>

<div id="overlay">ðŸŽ‰ STAGE CLEAR! ðŸŽ‰</div>

<script>
const STAGES=[...Array(100)].map((_,i)=>({
  rows:6+Math.floor(i/10),
  cols:6+Math.floor(i/10),
  colors:Math.min(5,3+Math.floor(i/20)),
  moves:15+i,
  goal:{ red:5+i }
}));

let stage=parseInt(localStorage.getItem("blastStage")||0);
let board=[],ROWS,COLS,COLORS,movesLeft,goal;

const grid=document.getElementById("grid");

function randColor(){
  return COLORS[Math.floor(Math.random()*COLORS.length)];
}

function initStage(){
  const s=STAGES[stage];
  ROWS=s.rows; COLS=s.cols;
  COLORS=["red","blue","yellow","green","purple"].slice(0,s.colors);
  movesLeft=s.moves;
  goal={...s.goal};

  board=[...Array(ROWS)].map(()=>[...Array(COLS)].map(()=>({type:"color",value:randColor()})));

  document.getElementById("stage").textContent=`Stage ${stage+1}`;
  updateUI();
  draw();
}

function updateUI(){
  document.getElementById("moves").textContent=`Moves: ${movesLeft}`;
  document.getElementById("goal").textContent=
    "Goal: "+Object.entries(goal).map(([k,v])=>`${k}:${v}`).join(" ");
}

function draw(){
  grid.style.gridTemplateColumns=`repeat(${COLS},1fr)`;
  grid.innerHTML="";
  board.forEach((row,r)=>row.forEach((cell,c)=>{
    const d=document.createElement("div");
    d.className="cell "+(cell.type==="color"?cell.value:cell.type);
    d.textContent=cell.type==="rocket"?"ðŸš€":cell.type==="bomb"?"ðŸ’£":"";
    d.onclick=()=>tap(r,c);
    grid.appendChild(d);
  }));
}

function tap(r,c){
  if(movesLeft<=0) return;
  const cell=board[r][c];
  if(!cell) return;

  if(cell.type!=="color"){
    explode([[r,c]]);
    useMove();
    return;
  }

  const group=[];
  flood(r,c,cell.value,group,{});
  if(group.length<2) return;

  let special=null;
  if(group.length>=6) special="bomb";
  else if(group.length>=4) special="rocket";

  explode(group,special);
  useMove();
}

function flood(r,c,color,group,seen){
  const k=r+","+c;
  if(seen[k]||r<0||c<0||r>=ROWS||c>=COLS) return;
  const cell=board[r][c];
  if(!cell||cell.type!=="color"||cell.value!==color) return;
  seen[k]=1;
  group.push([r,c]);
  flood(r+1,c,color,group,seen);
  flood(r-1,c,color,group,seen);
  flood(r,c+1,color,group,seen);
  flood(r,c-1,color,group,seen);
}

function explode(cells,special){
  cells.forEach(([r,c],i)=>{
    const idx=r*COLS+c;
    grid.children[idx]?.classList.add("fade");
    if(board[r][c]?.value && goal[board[r][c].value]>0) goal[board[r][c].value]--;
    board[r][c]=null;
  });

  if(special){
    const [r,c]=cells[0];
    board[r][c]={type:special};
  }

  setTimeout(()=>{
    collapse(); refill(); draw(); updateUI(); checkClear();
  },600);
}

function collapse(){
  for(let c=0;c<COLS;c++){
    let stack=[];
    for(let r=ROWS-1;r>=0;r--) if(board[r][c]) stack.push(board[r][c]);
    for(let r=ROWS-1;r>=0;r--) board[r][c]=stack.shift()||null;
  }
}

function refill(){
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)
    if(!board[r][c]) board[r][c]={type:"color",value:randColor()};
}

function useMove(){ movesLeft--; updateUI(); }

function checkClear(){
  if(Object.values(goal).every(v=>v<=0)){
    document.getElementById("overlay").style.display="flex";
    setTimeout(()=>{
      document.getElementById("overlay").style.display="none";
      stage++; localStorage.setItem("blastStage",stage);
      initStage();
    },1200);
  }
}

initStage();
</script>
</body>
</html>
