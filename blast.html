<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Blast Puzzle</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:system-ui,sans-serif;
  background:linear-gradient(180deg,#fff1f8,#e8f8ff);
  text-align:center;
  padding:12px;
}

a.back{
  display:inline-block;
  margin-bottom:6px;
  padding:6px 12px;
  background:white;
  border-radius:12px;
  text-decoration:none;
  color:#333;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
}

h2{margin:6px 0;}

.top{
  display:flex;
  justify-content:space-between;
  max-width:280px;
  margin:6px auto;
}

.panel{
  background:white;
  padding:6px 10px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
  font-size:14px;
}

.grid{
  display:grid;
  gap:6px;
  margin:10px auto;
}

.cell{
  width:42px;
  height:42px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  cursor:pointer;
}

.red{background:#ff7675;}
.blue{background:#74b9ff;}
.yellow{background:#ffeaa7;}
.green{background:#55efc4;}
.purple{background:#a29bfe;}

.rocket{background:#fd79a8;color:white;}
.bomb{background:#2d3436;color:white;}

.fade{
  animation:fade .6s forwards;
}
@keyframes fade{
  to{opacity:0;transform:scale(1.4);}
}

#overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.9);
  display:none;
  align-items:center;
  justify-content:center;
  font-size:36px;
  font-weight:bold;
}
</style>
</head>

<body>

<a href="index.html" class="back">‚Üê Back to Menu</a>
<h2 id="stage"></h2>

<div class="top">
  <div class="panel" id="moves"></div>
  <div class="panel" id="goal"></div>
</div>

<div id="grid" class="grid"></div>
<div id="overlay">üéâ CLEAR!</div>

<script>
const COLORS=["red","blue","yellow","green","purple"];
const COLS=6;
const ROWS=8;
const FADE=600;

let stage=Number(localStorage.getItem("blastStage")||1);
let movesLeft,goal,board=[];

function stageData(){
  const color = COLORS[stage % COLORS.length];
  return{
    moves:18+stage,
    goals:{ [color]:12+stage }
  };
}

function randColor(){
  return COLORS[Math.floor(Math.random()*COLORS.length)];
}

function init(){
  const d=stageData();
  movesLeft=d.moves;
  goal=JSON.parse(JSON.stringify(d.goals));
  board=[];

  for(let r=0;r<ROWS;r++){
    board[r]=[];
    for(let c=0;c<COLS;c++){
      board[r][c]={type:"color",value:randColor()};
    }
  }

  document.getElementById("stage").textContent=`Stage ${stage}`;
  updateUI();
  draw();
}

function updateUI(){
  document.getElementById("moves").textContent=`Moves: ${movesLeft}`;
  document.getElementById("goal").textContent =
    "Goal: " + Object.entries(goal)
      .map(([k,v]) => `${k}:${Math.max(0, Number(v)||0)}`)
      .join(" ");
}

function draw(){
  const g=document.getElementById("grid");
  g.style.gridTemplateColumns=`repeat(${COLS},1fr)`;
  g.innerHTML="";

  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const cell=board[r][c];
      const d=document.createElement("div");
      d.className="cell";
      if(cell){
        d.classList.add(cell.type==="color"?cell.value:cell.type);
        if(cell.fade) d.classList.add("fade");
        d.textContent=cell.type==="rocket"?"üöÄ":cell.type==="bomb"?"üí£":"";
        d.onclick=()=>tap(r,c);
      }
      g.appendChild(d);
    }
  }
}

function tap(r,c){
  if(movesLeft<=0||!board[r][c]) return;
  const cell=board[r][c];

  if(cell.type==="color"){
    const group=[];
    flood(r,c,cell.value,group,{});
    if(group.length<2) return;

    let special=null;
    if(group.length>=6) special="bomb";
    else if(group.length>=4) special="rocket";

    group.forEach(([x,y])=>{
      const v = board[x][y].value;
      if(goal[v] !== undefined && goal[v] > 0){
        goal[v]--;
      }
      board[x][y].fade=true;
    });

    draw();

    setTimeout(()=>{
      group.forEach(([x,y])=>board[x][y]=null);
      if(special){
        const [x,y]=group[0];
        board[x][y]={type:special};
      }
      collapse(); refill();
    },FADE);

    endMove();
    return;
  }

  activateSpecial(r,c,cell.type);
}

function flood(r,c,color,g,s){
  const k=r+","+c;
  if(s[k]||r<0||c<0||r>=ROWS||c>=COLS) return;
  const cell=board[r][c];
  if(!cell||cell.type!=="color"||cell.value!==color) return;
  s[k]=1; g.push([r,c]);
  flood(r+1,c,color,g,s);
  flood(r-1,c,color,g,s);
  flood(r,c+1,color,g,s);
  flood(r,c-1,color,g,s);
}

function activateSpecial(r,c,type){
  const targets=new Set();
  const add=(x,y)=>{if(x>=0&&y>=0&&x<ROWS&&y<COLS) targets.add(x+","+y);};

  if(type==="rocket"){
    for(let i=0;i<COLS;i++) add(r,i);
    for(let i=0;i<ROWS;i++) add(i,c);
  }

  if(type==="bomb"){
    for(let dr=-2;dr<=2;dr++)
      for(let dc=-2;dc<=2;dc++)
        add(r+dr,c+dc);
  }

  targets.forEach(t=>{
    const [x,y]=t.split(",").map(Number);
    if(board[x][y]) board[x][y].fade=true;
  });

  draw();

  setTimeout(()=>{
    targets.forEach(t=>{
      const [x,y]=t.split(",").map(Number);
      board[x][y]=null;
    });
    collapse(); refill();
  },FADE);

  endMove();
}

function collapse(){
  for(let c=0;c<COLS;c++){
    let stack=[];
    for(let r=ROWS-1;r>=0;r--) if(board[r][c]) stack.push(board[r][c]);
    for(let r=ROWS-1;r>=0;r--) board[r][c]=stack.shift()||null;
  }
}

function refill(){
  for(let r=0;r<ROWS;r++)
    for(let c=0;c<COLS;c++)
      if(!board[r][c]) board[r][c]={type:"color",value:randColor()};
  draw();
}

function endMove(){
  movesLeft--;
  updateUI();

  if(Object.values(goal).every(v=>v<=0)){
    document.getElementById("overlay").style.display="flex";
    setTimeout(()=>{
      document.getElementById("overlay").style.display="none";
      stage++;
      localStorage.setItem("blastStage",stage);
      init();
    },1000);
  }
}

init();
</script>

</body>
</html>
